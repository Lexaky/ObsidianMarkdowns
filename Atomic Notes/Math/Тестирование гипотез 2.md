**Created at** [17-11-2025 17:27]
**Tags**: #Математическая_статистика 
# Тестирование гипотез о равенстве средних двух генеральных совокупностей. Непараметрические критерии. Анализ качественных признаков. Критерий Хи-квадрат

#### Когда применяются непараметрические методы
Основные допущения t - критерия Стьюдента:
- Сравниваемые выборки происходят из норм распределения генеральной совокупности
	- Не принципиально для больших выборок (т.к. [[Центральная предельная теорема]])
- Использует средние и дисперсии
	- Эти параметры адекватно описывают нормально распределённую совокупность
	- Если распределение далеко от нормального
		- Выбросы
		- Несимметричная форма
	- Среднее и дисперсия дадут о нём неверное представление;
	- Неверными окажутся и критерии, основанные на этих параметрах
* Измеряемый признак не числовой или не вполне числовой
* Природа порядковых признаков такова, что о двух значениях можно сказать лишь какое больше или меньше, но в принципе нельзя - насколько или во сколько раз
* Любой количественный признак можно рассматривать как порядковый, но не наоборот

Это в случае небольшой выборки или сильные отклонения. Другой проблемный случай - когда данные не числовые. Знаем порядок, но разница между соседними категориями неизвестна. 
Необходим переход от чисел к рангам. Числа ранжируют по номерам и дальше работают с рангами. Тогда тип распределения уже не сильно интересует - работая с рангами, просто используем свойства чисел. При этом не нужно знать, что это за распределение и каковы его параметры.

#### Сравнение двух независимых выборок. Критерий Манна-Уитни
Как делали статистику для t-критерия? - из нормальной совокупности извлек много выборок, строили статистику.
Для непараметрических: из нормально распределённой совокупности извлекаем всевозможные выборки определённого объёма и строим распределение значений соответствующего критерия.
Упорядочиваем значения признака и переходим от реальных значений к их рангам. Перечисляем всевозможные варианты упорядочивания двух групп и найдём вероятность получить значение $W$, равное или превышающее наблюдаемое значение при условии истинности нулевой гипотезы.

Пример:
Представим, что есть 7 человек, на них испытали лекарства, но никто не знал, кто получил лекарство, а кто плацебо. Измерили суточный диурез (мл). Те, кто получил плацебо имели СД: (1000, 1380, 1200), а с препаратом (1400, 1600, 1180, 1220). Мы упорядочиваем их всех по порядку: 1000 = 1, 1180 = 2, 1200 = 3, 1220 = 4, 1380 = 5, 1400 = 6, 1600 = 7. Просуммировали ранги в каждой из групп (плацебо):
$$T = 9$$
То, что мы посчитали 9, это достаточно мало, чтобы отклонить гипотезу от отсутствии действия препарата? Рассмотрим совокупность всех возможных перестановок. После перехода к рангам не нужно рассматривать исходные величины.
$H_0$: гипотеза об отсутствии влияния препарата на диурез. Т.е. любой ранг может равновероятно оказаться в любой из групп. Число способов по-разному выбрать 3 ранга из 7 = 35:
$$C_n^k = \frac{n!}{(n-k)!k!}$$
Если расписывать честно - когда бы в контрольной группе оказались 1, 2, 3 ранги = сумма 6. 
(таблица с суммой рангов, всего 12 из 35 строк показаны)
![[Тестирование_гипотез_2_таблица_сумма_рангов1.png]]
6 можем набрать только 1 способом, 7 = 1 способом, 8 = 2 способом и т.д.

Если бы встретились ранги 5, 6, 7 - то это был бы самый худший вариант для плацебо.

![[Тестирование_гипотез_2_распределение_групп.png]]
Получили распределение, теперь можно считать вероятность.
Нулевая гипотеза состоит в том, чтобы получить 9 и меньше, поэтому должны прибавлять вероятности 9, 8, 7, 6. Т.е. вся вероятность будет $\frac{7}{35}$
Если бы мы получили 6 (сумму рангов), то получили бы вероятность $\frac{3}{35}$
По форме напоминает t-распределение, но распределение t непрерывно (в отличие от этого), также построено по бесконечной совокупности значений, вычисленных для бесконечного числа выборок из бесконечной нормально распределённой совокупности. Распределение T конечно и дискретно, то-есть имеет ступенчатый вид, принимая значения лишь в конечном числе целочисленных точек.
Уровни значимости сказать никогда не можем.
Вероятность $T=9$ равна $3 \over 35$, т.е. нулевую гипотезу отвергнуть мы не можем, и на самом деле $Pr(T \le 9) = {7 \over 35}$

Уровень значимости обычно принимают равным $5\%$ или $1\%$. Можно ли установить такой уровень в нашем примере? - Нет. У нас есть всего 13 разных значений T, поэтому уровень значимости может меняться только скачками. В качестве критического берут то значение T, которому соответствует уровень значимости, наиболее близкий к 1% или 5%. В нашем примере ближе всего к 5% находится уровень значимости $5.7\%$, соответствующий $T = 8$. Критические значения критерия Манна-Уитни приведены в таблице. Столбец критических значений содержит пары чисел. Различия статистически значимы, если $T$ не больше первого из них или не меньше второго. Например, когда в одной группе 3 человека, а в другой 6, различия статистически значимы, если $T \le 7$ или $T \ge 23$.
![[Тестирование_гипотез_2_таблица1.png]]
![[Тестирование_гипотез_2_таблица2.png]]

Критерий Манна-Уитни - непараметрический аналог t-критерия Стьюдента.

Как распределить ранги для совокупности:
$$5, 6, 6, 8, 9, 9, 10, 11, 11, 11$$
Ранги:
$$1,\ 2.5,\ 2.5,\ 4,\ 5.5,\ 5.5,\  7,\ 9,\ 9,\ 9$$
С ростом численности групп объём перебора растёт, например если объём каждой из групп равен 10, то число вариантов 184756.
При численности групп больше 8 (Выборка > 8) распределение T приближается к нормальному со среднем:
$$z_T = \frac{T - \mu_T}{\sigma_T}$$
Имеет стандартное нормальное распределение. Это позволяет сравнить $z_T$ с критическими значениями нормального распределения. Более точный результат обеспечивает поправка Йейтса: 
$$z_T = \frac {|T - \mu_T| - \frac 12} {\sigma_T}$$

$$\mu_T = \frac {n_м (n_м + n_б + 1)}{2}$$
и стандартное отклонение
$$\sigma_T = \sqrt {\frac {n_м n_б (n_м + nб + 1)}{12}}$$
где $n_M$ и $n_\sigma$ - объёмы меньшей и большей выборок. Если некоторые значения совпадают, стандартное отклонение должно быть уменьшено, согласно формуле:
$$\sigma_T = \sqrt {\frac {n_мn_б(N+1)}{12} - \frac {n_мn_б}{12N(N^2 - 1)} \sum(\tau_i - 1)t_i(t_i + 1)}$$
Где $N = n_м\ и\ n_б$ - общее число членов обеих выборок, $\tau_i$ - число значений $i$-го ранга, а суммирование производится по всем совпадающим рангам.

#### U-критерий Манна-Уитни
В R называется U-критерий Манна-Уитни - это оптимизация, в нём показатель U меняется немного по-другому.
U-критерий Манна-Уитни, в котором вместо $T$ вычисляют $U$. При этом $U=T - n_м(n_m + 1)/2$, где $n_м$ - численность меньшей из групп.
paired = FALSE - говорит о том, что данные независимые, иногда это может быть не так.

#### Сравнение парных выборок. Критерий Уиолкоксона
Непараметрический аналог парного критерия Стьюдента. Принцип критерия:
1. Для каждого объекта вычисляют величину изменения признака.
2. Все изменения упорядочивают по абсолютной величине (без учёта знака).
3. Затем рангам приписывают знак изменения и суммируют эти знаковые ранги - в результате получается значение критерия Уилкоксона $W$.
4. Используется информация об абсолютной величине изменения и его знаке (то-есть уменьшении или увеличении наблюдаемого признака).
Метод основан на рангах, поэтому не нуждается в предположениях о типе распределения изменений.
Как в случае с критерием Манна-Уитни, здесь также можно перечислить всевозможные величины $W$ и найти критическое значение.

Пример на сравнение парных выборок с критерием Уилкоксона.
Допустим, мы исследуем некоторый препарат, предположительно диуретик. Дадим его 6 добровольцам и сравним диурез до и после приёма препарата. У 5 человек диурез увеличился. Значит ли это, что препарат действует?
![[Тестирование_гипотез_суточный_диурез_таблица.png]]
1. Упорядочим изменения диуреза по абсолютной величине и присвоим ранги от 1 до 6.
2. Затем, приписав рангу каждого изменения соответствующий изменению знак, перейдём к знаковым рангам.
3. Вычислим сумму.
Если препарат не оказывает действия, сумма рангов со знаком $+$ должна быть примерно равна сумме рангов со знаком $-$, и значение $W$ окажется близким к $0$. Напротив, если препарат увеличивает (или уменьшает) диурез, будут преобладать положительные (отрицательные) ранги и значение $W$ будет отличным от нуля.

Всего $2^n$ варианта определения рангов. Если выборка состоит из 8 объектов, то $2^8 = 64$ варианта распределения.
![[Тестирование_гипотез_2_пример_диурез_снова_таблица.png]]
![[Тестирование_гипотез_2_диурёз_распределение.png]]
В четырёх случаях значение $W$ по абсолютной величине равно или превосходит $19$.
Если |W| > 19 был бы, то уровень значимости был бы $\frac{4}{64} = 0.0625$
Если число пар больше 20, то $W \rightarrow 0$
Таким образом, отвергая нулевую гипотезу при $|W| > 19$, мы обеспечиваем уровень значимости $4\over64$

Изменение диуреза в нашем опыте надо признать статистически не значимым: $P < 0.0625$.
На самом деле в таблице имеется 14 значений $W$, по абсолютной величине не меньших $13$.
Поскольку $14 \over 64 = 0.219$, мы могли бы записать $P < {14 \over 64}$. 

Как и для критерия Манна-Уитни, распределение $W$ не является непрерывным и поэтому нельзя указать критическое значение, для которого уровень значимости в точности равнялся бы, например, $5\%$.
В таблице приведены критические значения, наиболее близкие к 5% и 1% уровням значимости для случая, когда численность группы не превосходит $20$. Если число пар измерений больше 20, то распределение $W$ достаточно близко к нормальному со средним $\mu_W = 0$ и стандартным отклонением:
$$\sigma_W = \sqrt {n(n+1)(2n+1) \over6}$$
где n - число пар наблюдений (то-есть численность группы).
Можно таким образом использовать:
$$z_W = {W - \mu_W \over \sigma_W} = {W \over \sqrt {n(n+1)(2n+1) \over6}}$$
Чтобы приближение было более точным, используют поправку Йейтса на непрерывность:
$$z_W = {|W| - \frac12 \over \sqrt {n(n+1)(2n+1) \over6}}$$
![[Тестирование_гипотез_2_Критические_значения_W.png]]
#### Проверка гипотезы о распределении качественной переменной
Данные о курильщике качественные - либо курит, либо нет. Можем распределение частот построить (слайд с A, B, C), потом среднее вычислить и сравнить.
![[Тестирование_гипотез_2_курить_плохо.png]]


Про лекарства (исходим не из количественного показателя, а из результата, интерпретируемого как "помогло" или "не помогло").
![[Тестирование_гипотез_2_лекарства.png]]

#### Проверка более сложных гипотез
Больной поправился\не поправился:
* Лекарство (А/В)
* Опыт врача
* Возраст пациента
* Пол пациента
* Другие факторы

#### Анализ качественных признаков. Дихотомический признак
Пол: мужской/женский - всегда 2 значения
Монета: орёл/решка
и т.д.
Количественная характеристика признака определяется частотой p:
p - частота или долей 1-й, (1-p) - частота 0-ой

Биноминальное распределение: $\mu = p, \sigma ^2 = p(1-p)$
ЦПТ говорит, что оценка частоты при больших n приблизительно равна:
$$\hat p \approx N(p, p(1-p))$$
Если p близко к 0 или 1, то ЦПТ не работает.
Требование: $np > 4\ и\ n(1-p) > 4$
Для проверки частоты используем таблицу нормального распределения.
$H_0: \hat p = p^*$ - Z-критерий аналогично критерию Стьюдента.
Применяем t-статистику, т.к. теряем степень свободы, дисперсию считаем по выборке.

#### Совпадает ли наблюдаемое распределение с ожидаемым?
$H_0: p = 0.5\ \ \ \ H1: p \ne 0.5$
Хи-квадрат: расстояние, распределение, критерий.
Расстояние Хи-квадрат Пирсона:
$$\chi ^2 = \sum_{i=1}^n {(O_i - E_i)^2 \over E_i}$$

Пусть есть монета, она должна была выдать 50/50, при 60 бросках 30 и 30, но она, допустим, даёт 40 на 20.
O - observe - наблюдаемое
E - ожидаемое
Как выразить отличие - можем посчитать Евклидово расстояние
Но расстояние мало о чём говорит, потому что оно зависит от размера выборки, масштаба, шкалы измерений. Поэтому предлагается делить каждую разницу на корень из ожидаемого значения. Тогда получится более универсальная величина
$$X^2 = \sum_i^n{\frac{({O_i - {E_i})}^2}{E_i}}$$

Как будет выглядеть распределение Хи-квадрат в эксперименте с монеткой при многократном повторении эксперимента (при условии, что верна нулевая гипотеза)?
1. Распределение будет обладать явно выраженной асимметрией, большинство значений сгруппируются приблизительно около $6.7$.
2. Распределение будет близким к нормальному со средним, приблизительно равным $6.7$.
3. Распределение будет обладать явно выраженной асимметрией, большинство значений сгруппируются около нуля.
4. Распределение будет близким к нормальному со средним в нуле.
5. Это будет бимодальное распределение, т.к. мы суммируем отклонения по двум ячейкам.
![[Тестирование_гипотез_2_распределение_хи_квадрат_ор.png]]

#### Распределение хи-квадрат с k степенями свободы
Распределение хи-квадрат с k степенями свободы - это распределение суммы квадратов k независимых стандартных нормальных случайных величин. Для 1 степени свободы для критического значения 0.05 = 5.84.
$$\chi ^2 = ({40 - 30 \over \sqrt 30})^2 + ({20 - 30 \over \sqrt 30})^2$$
$6.84$ было бы аномально огромным.
Если степени свободы увеличивать, то распределение будет более походить на нормальное.
![[Тестирование_гипотез_2_степени_свобод.png]]

В опыте с игральной костью всего может быть 5 степеней свобод.


O (18, 55, 27)
E (25, 50, 25)
$$\frac{7^2}{25} + \frac {5^2}{50} + \frac{2^2}{25} = \frac{131}{50} = 2,62$$ Это вписывается в гипотезу, всё ок.

#### Эксперимент Менделя
![[Тестирование_гипотез_2_Эксперимент_Менделя.png]]
В одном из опытов эмпирическое распределение частот генотипов цвета гороха приняло следующий вид:
AA 18
Aa 55
aa 27
Чему будут равны ожидаемые значения частот, если предполагаемое теоретическое распределение имеет следующий вид:
AA 1:
Aa 2:
aa 1
$$\chi ^2 (df = 2, p=0.05) = 5.99$$

#### Анализ таблиц сопряжённости. Взаимосвязь качественных признаков.
![[Тестирование_гипотез_2_таблица_сопряжённости.png]]
Выписываем суммы каждой выборки. Чтобы понять, влияет или не влияет специальность на выбор у парней или девушек, то мы должны рассчитать доли парней и девушек: 63,4% и 36,6%. При верной H0 пропорции должны сохраняться. Это наблюдаемые значения, а мы считаем ожидаемые:
15.2 и 10.8 по математическим
8.8 и 6.2 по филологическим
Наблюдаемое число получилось ожидаемым.
$$f_{ij} = {f_i \cdot f_j \over N}$$
$f_i$ - число наблюдений в i-ой строке,
$f_j$ - число наблюдений в j-ом столбце,
N - общее количество наблюдений.
Расстояние Хи-квадрат Пирсона здесь применяется аналогичным образом.
Число степеней свобод = 1, т.к. даже когда таблица двумерная, можно из сумм и единственного известного значения в таблице получить остальные значения таблицы.
![[Тестирование_гипотез_2_ожидаемые_значения_таблицы_частот.png]]
$$\chi ^2 = {(15 - 15.2)^2\over 15.2} + {(9 - 8.8)^2 \over 8.8} + {(11 - 10.8)^2\over10.8} + {(6 - 6.2)^2\over6.2}$$

#### Анализ таблиц сопряжённости. Поправка Йетса
В теории распределение $\chi ^2$ непрерывно, но вычисляемые значения всегда дискретны, поэтому $H_0$ будет отвергаться слишком часто Чтобы скорректировать значения $p$-уровня значимости, применяется поправка Йетса на непрерывность. Обычно её используют, если в таблице некоторые ожидаемые частоты меньше 10.
$$\chi _{yets}^2 = \sum_{i=1}^n {(|O_i - E_i| - 0.5)^2 \over E_i}$$
При проверке гипотезы о взаимосвязи двух качественных признаков мы можем принять альтернативную гипотезу:
1. Только если наблюдаемые значения в каждой ячейке больше 10, иначе поправка Йетса не позволит отклонить нулевую гипотезу.
2. Только при условии очень слабых отклонений наблюдаемых от ожидаемых частот в каждой ячейке.
3. Только при условии очень сильных отклонений наблюдаемых от ожидаемых частот в каждой ячейке.
4. Если в таблице есть значимые отклонения между наблюдаемыми и ожидаемыми значениями хотя бы в некоторых ячейках.

#### Критерий Хи-квадрат Пирсона. Степени свободы. Предположения
Проверяет гипотезу о том, что наблюдаемое распределение качественного признака не отличается от ожидаемого. Для одной качественной переменной:
$$df = n - 1$$
где $n$ - количество столбцов таблицы.
Для таблиц сопряжённости:
$$df = (n-1) \cdot (m-1)$$
Где $n$ - количество столбцов таблицы, $m$ - число строк таблицы.
Все наблюдения независимы, минимальное количество наблюдений в каждой из ячеек должно быть больше 5.

#### Уточнение результатов
С помощью $mosaicplot$ (анализа остатков) можно выявить, какие именно частоты значимо отклоняются от ожидаемых значений.
![[Тестирование_гипотез_2_mosaicplot.png]]
Размер прямоугольников соответствует количеству наблюдений. Цвет прямоугольников - величине значимости отклонения ожидаемых и наблюдаемых частот в этой ячейке.
Если значения стандартизированных остатков больше 3х, можно считать, что в этой ячейке зафиксированы значимые отклонения.

#### Ссылки
1. [Лекции по математическим методам анализа данных 2025]( https://cloud.mail.ru/public/T6ge/9337oqgK3)
