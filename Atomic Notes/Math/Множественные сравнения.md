**Created at** [15-12-2025 15:16]
**Tags**: #Математическая_статистика
# Множественные сравнения. Дисперсионный анализ повторных наблюдений. Дисперсионный анализ по Краскелу-Уоллису

#### Дисперсия vs Вариация в ANOVA
Дисперсия (сумма квадратов отклонений, делённая на число степеней свободы):
$$MSW = \sum_{i=1}^k s_i^2 \cdot (n_i - 1) / (n - k)$$
$$MSB = \sum_{i=1}^k (\bar x_i - \bar x)^2 \cdot n_i / (k-1)$$
Где $\bar x_i$ - среднее по $i$-ой группе, $\bar x$ - среднее по всем группам, $n_i$ - количество наблюдений в $i$-ой группе, $n$ - общее число наблюдений (по всем группам). Число степеней свободы $df_B = k - 1$, $df_W = n-k$.

Теперь показателем разброса будет сумма квадратов отклонений, или вариация:
$$SW = \sum_{i=1}^k s_i^2 \cdot (n_i -1)$$
$$SB = \sum_{i=1}^k (\bar x_i - \bar x)^2 \cdot n_i$$

#### Однофакторный дисперсионный анализ
Ранее было несколько групп объектов, которые подвергались различным методам воздействия. В дисперсионном анализе повторных измерений:
одни и те же объекты последовательно подвергаются нескольким методам воздействия или просто наблюдаются в несколько последовательных моментах времени.

По-другому распределяется и общая вариация $S_T$:
Межиндивидуальная $S_{BI}$ и внутрииндивидуальная $S_{WI}$. Последняя распадается на обусловленную воздействием $S_f$ и остаточную $S_{er}$, обусловленную случайными колебаниями, ошибкой измерения и т.п.

![[Множественные_сравнения_ОДА1.png]]
Внутрииндивидуальная вариация - $S_{wi}$
$$S_{wi} = S_f + S{er}$$
Где $S_f$ - воздействие, $S_{er}$ - ошибка.

$\bar X_i$ - индивидуальные средние (средние значения признака при всех методах воздействия у $i$-го объекта)
$$\bar X_i = \sum_{j=1}^m {x_{ij} \over m}$$

$\bar T_i$ - средние значения признака у всех объектов при $i$-м методе воздействия:
$$\bar T_i = \sum_{i=1}^n {x_{ij} \over n}$$

$$F = {s_f^2\over s_{er}^2}$$
Где $s_{er}^2 = {s_{er}\over v_{er}}$, $v_{er} = (n-1)(m-1)$
$$s_f^2 = \frac {s_f}{v_f}, v_f = m-1$$
$n$ - количество объектов, $m$ - количество воздействий.

Общая вариация - это сумма квадратов отклонений всех значений от общего среднее: 
$$\bar X = \sum_{i=1}^m \sum_{j=1}^n \frac {x_{ij}}{mn}$$

Число степеней свободы $v_T = m \cdot n - 1$
Общая вариация складывается из межиндивидуальной и внутрииндивидуальной вариации:
$$S_T = S_{BI} + S_{WI}$$
Рассчитаем внутрииндивидуальную вариацию:
$$S_{WI} = \sum_{i=1}^n S_{Wi}$$
Число степеней свободы $v_{WI} = n(m-1)$
Межиндивидуальная вариация складывается из квадратов отклонений индивидуальных средних от общего среднего:
$$S_{BI} = m \sum_{i=1}^n (\bar X_i - \bar X)^2$$
Число степеней свободы $v_{BI} = n-1$

Из внутрииндивидуальной вариации выделим вариацию, связанную с воздействием $S_f$ и остаточную вариацию $S_{er}$.
$$S_f = n \sum_{i=1}^m (\bar T_i - \bar X)^2$$
Число степеней свободы $v_f = m-1$
$$S_{er} = S_{WI} - S_f$$
Число степеней свободы $v_{er} = v_{WI} - v_f = n(m-1) - (m-1) = (n-1)(m-1$)

Пример
Лёгочное сосудистое сопротивление у больных первичной лёгочной гипертензией на фоне лечения гидралазином
![[Множественные_сравнения_больные_гипертензия.png]]
![[Множественные_сравнения_больные.png]]


#### Множественные сравнения после ANOVA повторных измерений
При дисперсионном анализе повторных измерений схема использования критерия Стьюдента остаётся прежней.
Отличие: в формуле для $t$ вместо $s^2$ используют остаточную дисперсию $S_{er}^2$, а среднние по группам заменяют на средние по методам воздействия (моментам наблюдения) $\bar T_i$:
$$t = {\bar T_i - \bar T_j \over \sqrt {2S_{er}^2/n}}$$
Полученное значение нужно сравнить с критическим значением распределения Стьюдента $v_{er} = (n-1)(m-1)$ степенях свободы.

Вместо поправки Бонферрони можно воспользоваться более точным критерием Ньюмена-Кейлса или критерием Тьюки. Кроме того, когда измерения, выполненные до начала воздействия, играют роль "Контрольной группы", пригоден и критерий Даннета для множественного сравнения с контрольной группой.
При их применении нужно, как и в случае критерия Стьюдента с поправкой Бонферрони, в качестве оценки дисперсии брать остаточную дисперсию при нахождении критического значения использовать число степеней свободы остаточной вариации.

#### Дисперсионный анализ по Краскелу-Уоллису
Дисперсионный анализ по Краскелу-Уоллису - непараметрический аналог ANOVA.
Однофакторный дисперсионный анализ предполагает, что данные в каждой из групп, подчиняются нормальному распределению, причём дисперсии по всем группам примерно одинаковы.
Его непараметрическим аналогом не требует предположения о нормальности распределения. Критерий Крускала-Уоллиса представляет собой обобщения критерия Манна-Уитни.

Алгоритм:
1. Все значения упорядочивают по возрастанию, независимо от того, какой выборке они принадлежат.
2. Каждому значению присваивается ранг - номер его места в упорядоченном ряду.
3. Вычисляют суммы рангов, относящихся к каждой группе, для каждой группы определяют средний ранг.

При отсутствии межгрупповых различий средние ранги групп должны оказаться близки. Напротив, если существует значительное расхождение средних рангов, то гипотезу об отсутствии межгрупповых различий следует отвергнуть. Значение критерия Крускала-Уоллиса $H$ является мерой такого расхождения средних рангов.

#### Дисперсионный анализ по Краскелу-Уоллису. Вычисления
Для простоты предположим, что групп всего 3. Обобщение на большее число групп получится автоматически.
Имеются результаты измерения некоторого признака в 3 группах.
$R_1, R_2, R_3$ - суммы рангов значений в каждой группе.
$n_1, n_2, n_3$ - число наблюдений в каждой группе.
Средние ранги:
$$\bar R_i = {R_i\over n_i}, N = n_1 + n_2 + n_3 - \text{общее число наблюдений}$$
Для объединённой группы рангами являются числа $1, 2, ..., N$ и общая сумма рангов:
$$1 + ... + N = {N(N+1) \over 2}$$
Средний ранг общей группы $\bar R= \frac{N+1}2$, дисперсия $\sigma^2 = \frac{N^2 - 1}{12}$
Параметры дискретного равномерного распределения.
Аналог межгрупповой вариации:
$$D = n_1(\bar R_1 - \bar R)^2 + n_2(\bar R_2 - \bar R)^2 + n_3 (\bar R_3 -\bar R)^2$$
$D$ зависит от размеров групп:
Поделить $D$ на $\sigma_R^2$
Домножить на $(N-1)N$ (коррекция смещённости оценки дисперсии)
$$H = D \frac {N-1}{N} \cdot \frac {12}{N^2-1}$$
$$H = D \cdot \frac {12}{N(N+1)} - \text{значение критерия Краскела-Уоллиса}$$

Как найти критическое значение H? - Можно было бы просто перечислить все сочетания рангов (как для критериев Манна-Уитни и Уилкоксона), но число вариантов слишком велико. Если группы не слишком малы, распределение $H$ хорошо приближается распределением $\chi^2$ с числом степеней свободы $\nu = k - 1$, где $k$ - число групп.

В случае трёх групп приближение с помощью $\chi^2$ пригодно, если численность каждой группы не меньше 5. Для четырёх групп общее число наблюдений не менее 10. Но если группы совсем малы, не остаётся ничего, кроме как обратиться к таблице точных значений распределения Крускала-Уоллиса.

Если групп $m > 3$
$$D = \sum_{i=1}^m n_i (\bar R_i - \bar R)^2 - \text{аналог межгрупповой вариации}$$
$$H = D \cdot \frac {12}{N(N+1)} - \text{значение критерия Краскела-Уоллиса}$$
При большом числе совпадающих рангов значение $H$ следует поделить на:
$$1 - \frac{\sum_i (\tau_i - 1)\tau_i(\tau_i+1)}{N(N^2-1)}$$
Где $N$ - число членов всех групп, $\tau_i$ - как обычно, число рангов в $i$-й связке, а суммирование производится по всем связкам.

#### Непараметрическое множественное сравнение
Тесты Манна-Уитни к каждой группе, далее поправки Холма / Бонферрони. Специализированные непараметрическим post-hoc тесты. Непараметрические варианты критериев Ньюмена-Кейлса и Даннета - для выборок одинакового объёма. Когда же объёмы выборок различны, применяется критерий Данна.

#### Непараметрические варианты критериев Ньюмана-Кейлса и Даннета (выборки одинакового объёма)
Непараметрический вариант критерия Ньюмана-Кейлса:
$$q = {R_A - R_B \over \sqrt {\frac{n^2l(nl+1)}{12}}}$$
Где $R_A$, $R_B$ - суммы рангов двух сравниваемых выборок, n - объём каждой выборок, l - интервал сравнения. Вычисленное q сравнивается с критическим значением для бесконечного числа степеней свободы.

Непараметрический критерий Даннета:
$$q' = {R_{кон} - R_A \over \sqrt{\frac{nl(l+1)}{6}}}$$
Где $R_{кон}$ - сумма рангов контрольной выборки, а остальные величины те же, что в Критерии $q$. $l$ - число всех выборок, включая контрольную. Значение $q'$ сравнивается с критическим значением для бесконечного числа степеней свободы.

#### Критерий Данна для выборок неодинакового объёма
$$Q = {\bar R_A - \bar R_B \over \sqrt{\frac {N(N+1)}{12} (\frac 1{n_A} + \frac 1{n_B})} }$$
Где $R_A$ и $R_B$ - средние ранги двух сравниваемых выборок, $n_A$ и $n_B$ - их объёмы, а $N$ - общий объём всех сравниваемых выборок.
Критические значения $Q$ приведены в таблицах.
Критерием Данна можно воспользоваться и для сравнения с контрольной выборкой. Формула для $Q$ остаётся прежней, только критические значения уже находятся по другой таблице.
![[Множественные_сравнения_Таблица_критерий_Данна.png]]

#### Повторные измерения: критерий Фридмана

Если одна и та же группа объектов последовательно подвергается нескольким методам воздействия или наблюдается в разные моменты времени, применяют дисперсионный анализ повторных измерений. Но чтобы использование дисперсионного анализа было правомерно, данные должны подчиняться нормальному распределению. Если в этом уверенности нет, лучше воспользоваться критерием Фридмана - непараметрическим аналогом дисперсионного анализа повторных измерений.

Идея метода:
Каждый объект один раз подвергается каждому методу воздействия или наблюдается в фиксированные моменты времени.
Результаты наблюдений каждого объекта упорядочиваются. Раньше мы упорядочивали группы, теперь отдельно упорядочиваются значения у каждого объекта, независимо от всех остальных. Получается столько упорядоченных рядов, сколько объектов участвует в исследовании.

Далее для каждого метода воздействия (или момента наблюдения) вычислим сумму рангов. Если разброс сумм велик - различия статистически значимы.
Внутрииндивидуальная вариация - $S_{wi}$
$$S_{wi} = S_f + S_{er}$$
$$F = {s_f^2 \over s_{er}^2}$$
Критические значения критерия Фридмана:
![[Множественные_сравнения_Таблица_критерий_Фридмана.png]]

Пример
Лёгочное сосудистое сопротивление у больных первичной лёгочной гипертензией на фоне лечения гидралазином.
Измерения производили у 4 больных трижды: перед началом лечения, спустя 48 ч, спустя 3-6 месяцев лечения (1, 2 и 3 измерения):

| Больной | 1    | 2    | 3    |
| ------- | ---- | ---- | ---- |
| 1       | 22.2 | 5.4  | 10.6 |
| 2       | 17.0 | 6.3  | 6.2  |
| 3       | 14.1 | 8.5  | 9.3  |
| 4       | 17.0 | 10.7 | 12.3 |
![[Множественные_сравнения_пример_больных.png]]

Общая вариация - это сумма квадратов отклонений всех значений от общего среднего:
$$\bar X = \sum_{i=1}^m \sum_{j=1}^n \frac{x_{ij}}{mn}$$
$$S_T = \sum_{i=1}^m \sum_{j=1}^n (x_{ij} - \bar X)^2$$
Число степеней свободы $\nu_T = m \cdot n - 1$
Общая вариация складывается из межиндивидуальной и внутрииндивидуальной вариации:
$$S_T = S_{BI} + S_{WI}$$
Из внутрииндивидуальной вариации выделим вариацию, связанную с воздействием $S_f$ и остаточную вариацию $S_{er}$.
$$S_f = n\sum_{i=1}^n (\bar T_i - \bar X)^2$$
Число степеней свободы $\nu_f = m -1$
$$S_{er} = S_{WI} - S_f$$
Число степеней свободы $v_{er} = \nu_{WI} - \nu_f = n(m-1) - (m-1) = (n-1)(m-1)$

| $n$ | $\chi_r^2$ | $P$   |
| --- | ---------- | ----- |
| 3   | 6.00       | 0.028 |
| 4   | 6.50       | 0.042 |


#### Дополнительно с лекции

Общая вариация - все значения по выборке берутся, отнять среднее по выборке, возвести в квадрат всех разностей = общая вариация. Число степеней свободы $v_T = mn - 1$
В R нужно будет вручную реализовать однофакторный дисперсионный анализ.
xi <- rowMeans - средние по строчкам для каждого больного (индив средние)
ti <- colMeans - средние по лечению
X <- mean(xi) - общее среднее (оно в таблице $\hat X = 11,63$)
Sw <-sum(..) - общая вариация - от каждого X вычесть среднее индивидуальное значение.
Sw - индивидуальные вариации
ST - связанные с лечением вариации
Общая вариация должна состоять из той вариации, которая между группами SB и внутри группы SW:
$ST == (SB + SW)$
Sf - связанная с воздействием.
Из межгрупповой вычесть sf

На этих данных нельзя применять дисперсионный анализ, потому что они малые.
Показали, что различия есть (между 1 и 2 или между 2 и 3 или между 1 и 3? - нужно перейти к попарным сравнениям). Можно использовать парный критерий Стьюдента.

#### Ссылки
1. [Лекции по математическим методам анализа данных 2025]( https://cloud.mail.ru/public/T6ge/9337oqgK3)